name: CI

on:
  push:

jobs:
  build:
    if: "!contains(github.event.head_commit.message, '[auto]: ')"
    runs-on: ubuntu-latest
    container:
      image: archlinux
      options: --privileged
      volumes:
        - /sys/fs/cgroup:/sys/fs/cgroup

    steps:
    - name: Checkout Main Repo
      uses: actions/checkout@v2
      with:
        token: ${{ secrets.PAT }}

    - name: Setup User Account
      id: user
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm sudo
        useradd -m hmkdarfdas
        echo 'hmkdarfdas ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

    - name: Install YAY
      id: yay
      run: |
        pacman -S --noconfirm --needed git base-devel go
        su hmkdarfdas <<'EOF'
        _yaydir=$(mktemp -d)
        git clone https://aur.archlinux.org/yay.git ${_yaydir}
        cd ${_yaydir} && makepkg -si --noconfirm
        EOF
      if: steps.user.outcome == 'success'

    - name: Install Build Dependencies
      id: dependencies
      run: |
        su hmkdarfdas <<'EOF'
        rustup target add x86_64-unknown-linux-musl
        yay -S --noconfirm pyoxidizer
        EOF
      if: steps.yay.outcome == 'success'
